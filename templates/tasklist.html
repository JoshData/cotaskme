{% extends "base.html" %}

{% block title %}{{tasklist.title}} -- CoTask.me{% endblock %}

{% block body %}
<div class="container">


    {% if "observe" in roles %}
    <div class="col-sm-8">
    	<h2><a href="incoming">Incoming</a> | Outgoing</h2>
    	<table>
			<tr>
			  <th class="task">Task</th>
			  <th>Sent by</th> 
			  <th>Status</th>
			</tr>
			{% for task in tasks_outgoing %}
				{% include "task.html" %}
			{% endfor %}
    	</table>
    </div>
    {% endif %}

	</div>
</div>
{% endblock %}

{% block scripts %}
<script>
	{% if "admin" in roles %}
	function do_rename() {
		var elem = $('h1');
		do_action_with_input("rename", "Rename this task list?", elem.text(), function(new_value) {
				elem.text(new_value);
		});
	}

	function do_change_slug() {
		do_action_with_input("slug", "Change the URL of this task list?",
			"{{tasklist.slug|escapejs}}",
			function(new_value) {
				window.location = "/t/" + new_value;
		});
	}

	function do_action_with_input(action, prompt_text, default_value, callback) {
		var value = prompt(prompt_text, default_value);
		if (!value) return;
		do_action({ action: action, value: value }, action, callback, value);
	}

	function do_action(post_data, err_title, callback, callback_arg) {
	  	$.ajax(
	  		"{{tasklist.get_absolute_url}}/_action",
	  		{
	  			data: post_data,
	  			method: "POST",
	  			success: function(res) {
	  				if (res.status == "ok")
	  					callback(callback_arg);
	  				else
	  					show_modal_error(err_title, res.msg);
	  			},
	  			error: function() {
				  	show_modal_error(err_title, "There was an error, sorry.");
	  			}
	  		});
	}
	{% endif %}

	{% if "post" in roles %}
	function post_state(state) {
		var elems = $('#post_form input, #post_form select, #post_form textarea, #post_form button');
		elems.prop("disabled", !state);
	}

	function do_post() {
		if ($('#postTitle').val() == "") {
	  		show_modal_error("post a new task", "Type in a subject for the task.");
	  		return false;
		}

	  	$.ajax(
	  		"{{tasklist.get_absolute_url}}/_post",
	  		{
	  			data: {
	  				title: $('#postTitle').val(),
	  				notes: $('#postNodes').val(),
	  				incoming: $('#postIncoming').val(),
	  				autoclose: $('#postAutoClose').val()
	  			},
	  			method: "POST",
	  			success: function(res) {
				  	post_state(true);
	  				if (res.status != "ok") {
	  					show_modal_error("post a new task", res.msg);
	  					return;
	  				}

  					show_modal_error("post a new task", "Refresh the page please! :) Task has been posted.");

  					// reset fields to prevent double-submit
  					$('#postTitle').val('');
  					$('#postNotes').val('');
	  			},
	  			error: function() {
				  	show_modal_error("post a new task", "There was an error, sorry.");
				  	post_state(true);
	  			}
	  		});
		return false;
	}

	function change_task_state(task_id, new_state) {
		do_action({ action: "task-state", task: task_id, state: new_state }, "change state", function() { window.location.reload() });
	}
	{% endif %}
</script>
{% endblock %}
